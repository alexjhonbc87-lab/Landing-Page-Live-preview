# AI Landing Page Builder - Firestore Architecture

## 1. Database Overview
This application uses **Google Cloud Firestore** (NoSQL) to store landing pages.
*   **Collection Strategy:** Top-level `landingPages` collection.
*   **Why Top-Level?** To allow public access via a unique Page ID (e.g., `/page/123`) without needing to know the owner's User ID.

---

## 2. Collection Structure: `landingPages`

Each document represents one landing page.

### Document ID: `{pageId}` (Auto-generated UUID)

| Field | Type | Description |
| :--- | :--- | :--- |
| `id` | String | Same as Document ID (for easier frontend access). |
| `ownerId` | String | The Firebase Auth UID of the creator. **Critical for security.** |
| `title` | String | Internal name of the page (e.g., "Product Launch V1"). |
| `description` | String | Product description used for AI generation. |
| `htmlContent` | String | The full, raw HTML generated by the AI. |
| `subdomain` | String | The slug for the URL (e.g., "my-product"). |
| `createdAt` | Timestamp | Server timestamp of creation. |
| `updatedAt` | Timestamp | Server timestamp of last edit. |
| `isPublic` | Boolean | If `true`, anyone can read. If `false`, only owner can read. |
| `publicUrl` | String | Full URL: `https://landingpages-theta.vercel.app/page/{pageId}` |

### Example JSON Document
```json
{
  "id": "8s9d8f9s8d7f",
  "ownerId": "xb23456789abc",
  "title": "Crypto Course Launch",
  "description": "A beginner course on Ethereum...",
  "htmlContent": "<!DOCTYPE html><html>...</html>",
  "subdomain": "crypto-course",
  "createdAt": "2024-02-20T10:00:00Z",
  "updatedAt": "2024-02-20T10:05:00Z",
  "isPublic": true,
  "publicUrl": "https://landingpages-theta.vercel.app/page/8s9d8f9s8d7f"
}
```

---

## 3. Security Rules (`firestore.rules`)

These rules ensure data privacy and integrity.

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    match /landingPages/{pageId} {
      
      // READ: Allowed if user owns the page OR if the page is public
      allow read: if isOwner() || isPublic();

      // CREATE: Allowed if user is authenticated and sets themselves as owner
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;

      // UPDATE: Only owner can update. 
      // Preventing ownership transfer: Owner ID must remain the same.
      allow update: if isOwner() && request.resource.data.ownerId == resource.data.ownerId;

      // DELETE: Only owner can delete
      allow delete: if isOwner();
    }

    // --- Helper Functions ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner() {
      return isSignedIn() && resource.data.ownerId == request.auth.uid;
    }

    function isPublic() {
      return resource.data.isPublic == true;
    }
  }
}
```

---

## 4. Workflows & Implementation

### A. Saving a Page (Private Draft)
1.  User clicks "Save" or "Generate".
2.  Frontend calls `saveLandingPage()`.
3.  Firestore creates a doc with `isPublic: false`.
4.  **Result:** Page is saved, but accessing the URL returns 403 (Permission Denied) for anyone but the owner.

### B. Publishing a Page
1.  User clicks "Deploy" / "Publish".
2.  Frontend calls `publishPage(pageId)`.
3.  Firestore updates doc to `isPublic: true`.
4.  **Result:** The URL `https://landingpages-theta.vercel.app/page/{pageId}` becomes accessible to the world.

### C. Public Visitor Access
1.  Visitor clicks a shared link.
2.  Frontend loads `/page/{pageId}` route.
3.  Frontend queries Firestore for that ID.
4.  **Scenario 1 (Public):** Firestore returns JSON -> Frontend renders HTML in iframe/container.
5.  **Scenario 2 (Private/Deleted):** Firestore throws error -> Frontend shows 404 Page.

---

## 5. Deployment Note (Vercel)

To support the dynamic public URL, your `App.tsx` must utilize React Router (or similar logic) to handle the path:
`https://landingpages-theta.vercel.app/page/:pageId`

The `Deployment` logic in the builder should generate this exact URL structure.
